#!/bin/sh

url=$(xclip -o)

case $1 in
	-e) $EDITOR $(readlink -f "$0") && exit ;;
esac
[ -n "$url" ] && [ -z "$(echo $url | grep '^htt')" ] \
	&& printf "pon url del elemento a descargar: " && read -r url 
[ -z "$url" ] && printf "pon url del elemento a descargar: " && read -r url

dir=/tmp/vid/
tiempo=$(date +%Y%m%d%H%M%S)

[ ! -f $dir ] && mkdir -p $dir

select=fzf

vid=$(cat << EOF | fzf --prompt='elige opcion: '
ver formatos en servidor
descargar miniatura
descargar video
descargar por defecto (720 o 360)
descargar parte de video
descargar parte de video sin audio
descargar parte de audio
descargar lista reproduccion
descargar metadatos (json)
descargar audio solo
EOF
)

case $vid in
	ver*) youtube-dl -F "$url";;
	"descargar miniatura") youtube-dl --write-thumbnail --skip-download "$url";;
	"descargar video") formato=$(youtube-dl -F "$url"| tail -n +4 \
		|fzf --tac -m --prompt="tab para seleccionar, pon codigo (primero del video, luego audio): " \
		|cut -d' ' -f1 | paste -d' ' - - | tr ' ' '+') \
		&& youtube-dl -4 -f $formato $url\
		&& notify-send "video descargado en $dir";;
	"descargar por defecto (720 o 360)") youtube-dl "$url";;
	" ") youtube-dl -g "$url" | awk '{ if(NR==1) print $0 }' | sed "s/^/'/;s/$/'/" |xargs -I {} ffmpeg -i "{}" \
		-c:v copy -ss 0 -t 10 pruebar.mp4;;
	"descargar parte de video") youtube-dl -F "$url" && printf "elige resolucion: " \
		&& read -r resol && printf "desde donde quieres cortar (inicio)? " \
		&& read -r inicio && printf "hasta donde quieres cortar? " \
		&& read -r fin && youtube-dl -f "$resol" -g "$url"| 
		awk '{ if(NR==1) print $0 }' | sed "s/^/'/;s/$/'/" | xargs -I {} ffmpeg -hide_banner -i "{}" \
		-c:v libx264 -ss $inicio -to $fin /tmp/$tiempo.mkv;;
	"descargar parte de audio") printf "comienzo: " && read -r com && printf "fin: " && read -r fin \
		&& youtube-dl -g "$url" |awk '{ if(NR==2) print $0 }' | sed "s/^/'/;s/$/'/" | xargs -I {} ffmpeg \
		-hide_banner -i "{}" -ss "$com" -to "$fin" $dir$tiempo.mp3;;
	"7") youtube-dl -i $dir$tiempo"%(title)s.%(ext)s" "$url" ;;
	"descargar metadatos") youtube-dl --write-info-json "$url";;
	"descargar audio solo") youtube-dl -F "$url" | grep 'audio' && printf "pon codigo: " && read -r codigo \
		&& youtube-dl -f "$codigo" "$url" \
		&& notify-send "video descargado en $dir";;
esac
echo

#ffplay -i "url"
#add quotes between
#sed 's/^/"/;s/$/"/'

